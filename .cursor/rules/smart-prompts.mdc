---
alwaysApply: true
---

# Smart Prompts Architecture - Context-Aware Risk Assessment

## CRITICAL: Context-Driven, Not Rule-Driven

**When user requests an action, you MUST:**

1. **Gather context** (files, branch, state, coordination, CI, etc.)
2. **CRITICAL: Check if rule-required first** - If rule says "IMMEDIATELY"/"MANDATORY"/"CRITICAL", always PROCEED
3. **If not rule-required, evaluate context holistically** using the sub-prompt below
4. **Get decision** (PROCEED/QUICK_CONFIRM/FULL_REVIEW/BLOCK)
5. **Execute with appropriate prompt level** (or skip if PROCEED)

**CRITICAL: Rule-required actions always PROCEED** - they bypass evaluation because they're mandated by rules.

## Project Context

**Learning Project:**
- **No real end users** - Lower risk tolerance
- **Public but experimental** - Safety less critical than production
- **Learning-focused** - Prompts that teach are valuable, but overhead still matters
- **Experimentation encouraged** - More aggressive optimization justified

**Impact on Thresholds:**
- **More aggressive PROCEED** - 85% of routine operations (vs. 70% for production)
- **Lower risk tolerance** - Can experiment freely
- **Still protect critical** - Main branch, security, shared files

## Context Evaluation Sub-Prompt

**When user requests action, internally evaluate using this sub-prompt:**

```
[INTERNAL EVALUATION SUB-PROMPT]

STEP 1: Check if rule-required
- If action is marked "IMMEDIATELY"/"MANDATORY"/"CRITICAL" in rules ‚Üí PROCEED immediately
- Examples: Creating branch when on main, rule-required checks

STEP 2: Detect multi-agent context
- Check worktrees: `git worktree list`
- Check active branches: `git branch -a`
- Check coordination doc: `docs/development/AGENT_COORDINATION.md`
- If 2+ agents active ‚Üí Lower thresholds (context switching cost: 20-45 sec)

STEP 3: Evaluate context holistically

CONTEXT:
- Action: [what user wants to do]
- Files: [list of files being modified]
- Change type: [feature/fix/refactor/config/docs]
- Branch: [current branch name]
- Branch state: [clean/behind/ahead/conflicts]
- Other agents: [active? working on same files?]
- Coordination: [checked? conflicts?]
- CI status: [if applicable]
- User intent: [explicit/uncertain/asking for help]
- Complexity: [simple/moderate/complex]
- Dependencies: [what this affects]
- Learning project: [yes - no real users]

EVALUATION QUESTIONS:
1. What could go wrong if this proceeds?
2. Is this a routine, safe operation?
3. Are there any red flags (main branch, conflicts, shared files)?
4. Does the user seem confident or uncertain?
5. What's the scope of impact (isolated vs system-wide)?
6. Multi-agent context? (lowers thresholds if 2+ agents)

DECISION (Learning Project Thresholds):
- PROCEED: Safe, routine, isolated, user intent clear ‚Üí Execute directly (85% of routine operations)
- QUICK_CONFIRM: Should confirm but straightforward ‚Üí Brief summary (12% of operations)
- FULL_REVIEW: Needs careful review ‚Üí Detailed summary (3% of operations)
- BLOCK: Dangerous, must prevent ‚Üí Block and explain (0% unless critical)

Respond: [DECISION] - [brief reasoning]
```

## Decision Outcomes

| Decision | Action | Example | Learning Project Threshold |
|----------|--------|---------|---------------------------|
| **PROCEED** | Execute directly | `‚úÖ Added comment` | 85% of routine operations |
| **QUICK_CONFIRM** | Brief summary | `üìã Commit 3 files? (y/n)` | 12% of operations |
| **FULL_REVIEW** | Detailed summary | `üìã SUMMARY: [details]... Proceed? (y/n)` | 3% of operations |
| **BLOCK** | Prevent + explain | `‚ùå CRITICAL: [why blocked]... Fix? (y/n)` | 0% unless critical |

## Learning Project Thresholds

### Routine Commits ‚Üí 85% PROCEED

**When to PROCEED (Learning Project - More Aggressive):**
- ‚úÖ Isolated feature/fix (not shared files)
- ‚úÖ Clean branch (not main, up to date)
- ‚úÖ No coordination conflicts
- ‚úÖ **Any complexity** (learning project, can experiment)
- ‚úÖ **Multiple files OK** (if related, learning project)
- ‚úÖ User intent explicit
- ‚úÖ **Learning project context** - Lower risk, can experiment

**When to QUICK_CONFIRM:**
- ‚ö†Ô∏è Shared files modified (coordination needed)
- ‚ö†Ô∏è **Only genuinely moderate risk** (not just "multiple files")

**When to FULL_REVIEW:**
- ‚ö†Ô∏è Major changes (architecture, system-wide)
- ‚ö†Ô∏è High risk (build files, security)
- ‚ö†Ô∏è Coordination conflicts
- ‚ö†Ô∏è **Only genuinely high risk** (not just "complex")

**When to BLOCK:**
- ‚ùå On main branch (rule-required, always block)
- ‚ùå Dangerous operation (security, data loss)
- ‚ùå Rule violation (always block)

### Routine Pushes ‚Üí 80% PROCEED

**When to PROCEED:**
- ‚úÖ Standard push (not force)
- ‚úÖ **Any number of commits** (learning project, can push freely)
- ‚úÖ Clean branch state
- ‚úÖ **Behind main OK** (learning project, can experiment)

**When to QUICK_CONFIRM:**
- ‚ö†Ô∏è Force push (genuinely risky)
- ‚ö†Ô∏è **Only genuinely risky operations**

**When to BLOCK:**
- ‚ùå Force push to main
- ‚ùå Dangerous operation

### Starting Work ‚Üí 100% PROCEED (Rule-Required)

**When to PROCEED:**
- ‚úÖ Always (rule-required check)
- ‚úÖ Auto-create branch if on main
- ‚úÖ Auto-check coordination
- ‚úÖ Show summary (no approval needed)

### CI/CD Routine Fixes ‚Üí 70% PROCEED

**When to PROCEED:**
- ‚úÖ Version update (actions, dependencies)
- ‚úÖ Config tweak (timeout, cache)
- ‚úÖ Routine maintenance
- ‚úÖ **Learning project, can experiment**

**When to QUICK_CONFIRM:**
- ‚ö†Ô∏è New workflow (moderate risk)
- ‚ö†Ô∏è **Only moderate risk** (not just "CI/CD change")

**When to FULL_REVIEW:**
- ‚ö†Ô∏è Security changes (still important)
- ‚ö†Ô∏è Major architecture changes
- ‚ö†Ô∏è **Only genuinely high risk**

## Multi-Agent Context Detection

**When 2+ agents are active:**
- **Context switching cost**: 20-45 seconds per prompt
- **Prompts compound**: 2-3x frequency
- **Lower thresholds**: Routine operations should PROCEED
- **Only prompt for**: Genuinely risky operations

**Detection:**
- Check worktrees: `git worktree list`
- Check active branches: `git branch -a`
- Check coordination doc: `docs/development/AGENT_COORDINATION.md`

**Threshold Adjustments:**
- **Single-agent**: 85% commits ‚Üí PROCEED
- **Multi-agent**: 85% commits ‚Üí PROCEED (same, but context switching makes it more important)
- **Routine operations**: PROCEED in multi-agent context to avoid disruption

## Context Factors (For AI Evaluation)

The AI considers:
- **Multi-agent context**: 2+ agents active? (lowers thresholds, 20-45 sec context switching cost)
- **Change scope**: Single file vs system-wide
- **Change type**: Docs vs feature vs config
- **Dependencies**: Isolated vs core infrastructure
- **State**: Branch status, conflicts, CI
- **Coordination**: Other agents, shared files
- **Complexity**: Simple vs complex
- **User confidence**: Explicit vs uncertain
- **Learning project**: No real users = more aggressive optimization

## Examples

### Example 1: Routine Commit (PROCEED)

**User:** "Commit these changes"

**Context:**
- Files: 2 files, isolated feature
- Branch: feature/new-feature (not main)
- State: Clean, up to date
- Other agents: None
- User intent: Explicit
- Learning project: Yes

**Evaluation:**
- What could go wrong? Nothing - isolated feature, not main
- Routine? Yes, very routine
- Red flags? None
- User confidence? High
- Impact? Minimal
- Multi-agent? No

**Decision: PROCEED**

**User sees:** `‚úÖ Committed changes to feature/new-feature` (no prompt)

### Example 2: Commit to Main (BLOCK)

**User:** "Commit these changes"

**Context:**
- Files: build.gradle.kts (high risk)
- Branch: main
- State: Clean
- Other agents: None
- User intent: Explicit but may not realize danger
- Learning project: Yes

**Evaluation:**
- What could go wrong? CRITICAL - committing to main, build files
- Routine? NO - never commit to main, especially build changes
- Red flags? YES - on main branch, build files, system-wide impact
- User confidence? Medium - explicit request but may not realize danger
- Impact? CRITICAL - build changes affect entire system
- Multi-agent? No

**Decision: BLOCK**

**User sees:**
```
‚ùå CRITICAL: Cannot commit to main branch
   ‚Ä¢ Current branch: main
   ‚Ä¢ Changes include: build.gradle.kts (high risk)
   ‚Ä¢ Impact: Could break entire build system
   
   Action required:
   1. Create feature branch first
   2. Move changes to feature branch
   3. Then commit
   
   Would you like me to create a feature branch and move these changes? (y/n)
```

### Example 3: Routine Push (PROCEED)

**User:** "Push my branch"

**Context:**
- Branch: feature/new-feature
- Commits: 3 commits, standard push
- State: Clean, up to date
- Other agents: None
- User intent: Explicit
- Learning project: Yes

**Evaluation:**
- What could go wrong? Nothing - standard push, not force
- Routine? Yes, very routine
- Red flags? None
- User confidence? High
- Impact? Minimal
- Multi-agent? No

**Decision: PROCEED**

**User sees:** `‚úÖ Pushed feature/new-feature to remote` (no prompt)

### Example 4: Multi-Agent Context (Lower Thresholds)

**User:** "Commit these changes"

**Context:**
- Files: 2 files, isolated feature
- Branch: feature/new-feature
- State: Clean
- Other agents: Yes (2 other worktrees active)
- User intent: Explicit
- Learning project: Yes
- Context switching cost: 30 seconds per prompt

**Evaluation:**
- What could go wrong? Nothing - isolated feature
- Routine? Yes, very routine
- Red flags? None
- User confidence? High
- Impact? Minimal
- Multi-agent? YES - context switching cost makes prompts disruptive

**Decision: PROCEED** (even more important in multi-agent context)

**User sees:** `‚úÖ Committed changes to feature/new-feature` (no prompt, avoids context switching)

## Implementation Guidelines

### For AI Agents

**When user requests action:**

1. **Gather context** (files, branch, state, coordination, etc.)
2. **CRITICAL: Check if rule-required first** - If rule says "IMMEDIATELY"/"MANDATORY"/"CRITICAL", always PROCEED
3. **If not rule-required, use sub-prompt to evaluate** (internally, natural reasoning)
4. **Get decision** (PROCEED/QUICK_CONFIRM/FULL_REVIEW/BLOCK)
5. **Execute with appropriate prompt level** (or skip if PROCEED)
6. **Learn from outcome** (refine evaluation for future)

**Sub-prompt evaluation should be:**
- **Fast**: < 1 second evaluation
- **Holistic**: All factors considered together
- **Natural**: Uses AI reasoning, not rigid formulas
- **Adaptive**: Learns from patterns
- **Transparent**: User can see reasoning if needed (optional)

**CRITICAL: Rule-required actions always PROCEED** - they bypass evaluation because they're mandated by rules.

### Key Principles

1. **No rigid scoring** - AI evaluates holistically
2. **Natural reasoning** - Uses AI capabilities, not formulas
3. **Context-aware** - Considers full situation
4. **Adaptive** - Learns from patterns
5. **Learning project** - More aggressive optimization (85% vs 70% PROCEED)

## Related Documentation

- `docs/development/workflow/SMART_PROMPTS_ARCHITECTURE.md` - Complete architecture
- `docs/development/workflow/SMART_PROMPTS_COMPREHENSIVE_OPTIMIZATION.md` - Optimization analysis
- `docs/development/workflow/SMART_PROMPTS_QUICK_REFERENCE.md` - Quick reference
- `.cursor/rules/branching.mdc` - Branch workflow rules
- `.cursor/rules/frequent-commits.mdc` - Commit frequency rules
