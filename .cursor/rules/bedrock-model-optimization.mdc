---
alwaysApply: true
---

# AWS Bedrock Model Optimization

## CRITICAL: Automatically Optimize Model Selection

**Before processing ANY user prompt, analyze it and automatically prepend the optimal model instruction when appropriate.**

## Automatic Model Selection Logic

### Step 1: Analyze User Prompt

**Before processing the prompt, evaluate:**

1. **Is it a simple task?**
   - Keywords: "format", "rename", "comment", "style", "syntax", "fix typo"
   - Short requests (< 50 words)
   - Single file operations
   - No complex logic mentioned
   - **→ Prepend: "Use Haiku model: "**

2. **Is it a complex task?**
   - Keywords: "architecture", "design", "complex", "difficult", "debug", "race condition", "security"
   - Multi-file operations
   - Security-sensitive
   - Research/analysis
   - User mentions struggling or complexity
   - **→ Prepend: "Use Opus model: "**

3. **Is it a standard task?**
   - Feature implementation
   - Code refactoring
   - Test writing
   - Documentation
   - Standard debugging
   - Code reviews
   - **→ No prepend (use default Sonnet)**

### Step 2: Automatically Prepend Model Instruction

**When a different model is optimal, automatically modify the prompt:**

**For Simple Tasks (Haiku):**
```
Original: "Format this code block"
Modified: "Use Haiku model: Format this code block"
```

**For Complex Tasks (Opus):**
```
Original: "Design a new data synchronization architecture"
Modified: "Use Opus model: Design a new data synchronization architecture"
```

**For Standard Tasks (Sonnet - default):**
```
Original: "Implement a new settings screen"
Modified: [No change - use default Sonnet]
```

## Implementation Rules

### ✅ DO: Automatic Prepend

**Always prepend when:**
- Simple task detected → Prepend "Use Haiku model: "
- Complex task detected → Prepend "Use Opus model: "
- User explicitly requests a model → Use their request
- No user interaction needed - do it automatically

### ❌ DON'T: Ask User

**Never ask the user:**
- Don't say "Would you like to use Haiku?"
- Don't say "Should I use Opus?"
- Don't interrupt workflow
- Just automatically optimize

### ✅ DO: Silent Optimization

**Make it seamless:**
- Analyze prompt silently
- Prepend model instruction automatically (user doesn't see this)
- Process with optimal model
- User's original prompt remains unchanged in UI
- Optionally mention model in response for transparency (e.g., "Using Haiku for cost efficiency")
- Most of the time, no mention needed - just work seamlessly

## Detection Patterns

### Simple Task Indicators

**Keywords:**
- "format", "rename", "comment", "style", "syntax", "fix typo", "indent", "clean up"
- "add comment", "update comment", "remove comment"
- "rename variable", "rename function", "rename class"
- "fix formatting", "fix style", "fix syntax"

**Patterns:**
- Short requests (< 50 words)
- Single file operations
- No complex logic
- Straightforward edits

**Example Detections:**
```
"Format this code" → Simple → Prepend "Use Haiku model: "
"Rename this variable" → Simple → Prepend "Use Haiku model: "
"Add a comment here" → Simple → Prepend "Use Haiku model: "
```

### Complex Task Indicators

**Keywords:**
- "architecture", "design", "complex", "difficult", "debug", "race condition"
- "security", "vulnerability", "encryption", "authentication"
- "multi-file", "across files", "refactor entire"
- "research", "analyze", "investigate", "optimize performance"
- "struggling", "can't figure out", "stuck", "not working"

**Patterns:**
- Multi-file operations
- Security-sensitive
- Research/analysis
- User mentions difficulty

**Example Detections:**
```
"Design a new architecture" → Complex → Prepend "Use Opus model: "
"Debug this race condition" → Complex → Prepend "Use Opus model: "
"I'm struggling with this bug" → Complex → Prepend "Use Opus model: "
```

### Standard Task Indicators

**Keywords:**
- "implement", "add feature", "create", "build"
- "refactor", "improve", "update"
- "write test", "add test", "test for"
- "document", "documentation"
- "review", "code review"

**Patterns:**
- Feature implementation
- Standard refactoring
- Test writing
- Documentation
- Code reviews

**Example Detections:**
```
"Implement a new screen" → Standard → No prepend (use Sonnet)
"Refactor this function" → Standard → No prepend (use Sonnet)
"Write tests for this" → Standard → No prepend (use Sonnet)
```

## Model Information

### Claude 3.5 Haiku
- **Model ID**: `anthropic.claude-3-5-haiku-20241022-v2:0`
- **Cost**: $0.80/$4.00 per million tokens (73% cheaper than Sonnet)
- **Speed**: Very fast
- **Use For**: Simple tasks (formatting, renaming, comments, quick fixes)

### Claude 3.5 Sonnet (Default)
- **Model ID**: `anthropic.claude-sonnet-4-5-20250929-v1:0`
- **Cost**: $3.00/$15.00 per million tokens
- **Speed**: Fast
- **Use For**: Standard development work (80% of tasks)

### Claude 3 Opus
- **Model ID**: `anthropic.claude-3-opus-20240229-v1:0`
- **Cost**: $15.00/$75.00 per million tokens (5x Sonnet)
- **Speed**: Slower
- **Use For**: Complex tasks (architecture, difficult debugging, security)

## Examples

### Example 1: Simple Task (Auto Haiku)
```
User Prompt: "Format this code block"

Analysis: Simple task detected (formatting)
Action: Automatically prepend "Use Haiku model: "
Modified Prompt: "Use Haiku model: Format this code block"
Result: Uses Haiku automatically (73% cheaper, faster)
```

### Example 2: Standard Task (Auto Sonnet)
```
User Prompt: "Implement a new settings screen"

Analysis: Standard task detected (feature implementation)
Action: No prepend needed
Modified Prompt: "Implement a new settings screen"
Result: Uses Sonnet automatically (default)
```

### Example 3: Complex Task (Auto Opus)
```
User Prompt: "Design a new data synchronization architecture"

Analysis: Complex task detected (architecture design)
Action: Automatically prepend "Use Opus model: "
Modified Prompt: "Use Opus model: Design a new data synchronization architecture"
Result: Uses Opus automatically (better results for complex tasks)
```

### Example 4: User Explicit Request (Respect User)
```
User Prompt: "Use Opus: Review this security-sensitive code"

Analysis: User explicitly requested Opus
Action: Use Opus (user request takes precedence)
Modified Prompt: "Use Opus: Review this security-sensitive code"
Result: Uses Opus as requested
```

## Cost Optimization Impact

**Automatic optimization results:**
- Simple tasks → Haiku (73% cost savings)
- Standard tasks → Sonnet (optimal balance)
- Complex tasks → Opus (better results, justified cost)

**Expected savings**: 50-65% overall cost reduction

## User Experience

**Seamless and automatic:**
- ✅ No user decisions needed
- ✅ No interruptions
- ✅ Optimal model selected automatically
- ✅ User just codes normally

**Transparency (Optional):**
- The prepended model instruction is sent to the model but NOT displayed to the user
- User sees their original prompt unchanged in the UI
- Optionally mention model in response for cost awareness (e.g., "Using Haiku for this simple task to save costs")
- Most of the time, no mention needed - just work seamlessly

## Related Documentation

- `docs/development/setup/AWS_BEDROCK_MODEL_OPTIMIZATION.md` - Complete optimization guide
- `docs/development/setup/AWS_BEDROCK_QUICK_REFERENCE.md` - Quick reference card
- `docs/development/setup/AWS_BEDROCK_SETUP.md` - Setup guide
