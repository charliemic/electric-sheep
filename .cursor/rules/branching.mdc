---
alwaysApply: true
---

# Branch Isolation and Multi-Agent Workflow

## When This Applies
Before making ANY changes to code.

## Critical Requirements

### Before Starting Work
- ✅ **Never work on `main` branch** - Always create feature branch first
- ✅ **Run pre-work check**: `./scripts/pre-work-check.sh` (validates branch, coordination, tools)
- ✅ **Use proper naming**: `feature/<description>`, `fix/<description>`, `refactor/<description>`, `docs/<description>`, `test/<description>`

### Branch Creation
```bash
# Standard branch
git checkout -b feature/<task-description>

# For isolation (recommended for shared files)
./scripts/create-worktree.sh <task-name>
```

### During Work
- ✅ **Commit frequently** (every 15-30 min, WIP commits OK)
- ✅ **Check coordination** before modifying shared files
- ✅ **Run tests** before committing: `./gradlew test`

### After Merge
- ✅ **Run cleanup**: `./scripts/post-merge-cleanup.sh <pr-number>`
- ✅ **Check other work** before deleting branches/worktrees

## Implementation

**Automated helpers:**
- `scripts/pre-work-check.sh` - Validates branch, coordination, discovers rules
- `scripts/create-worktree.sh` - Creates isolated worktree
- `scripts/post-merge-cleanup.sh` - Cleans up after merge
- `scripts/check-agent-coordination.sh` - Checks for file conflicts

**Coordination:**
- Check `docs/development/AGENT_COORDINATION.md` before modifying shared files
- Update coordination doc when work status changes

**Shared files (require coordination):**
- `app/.../ui/screens/LandingScreen.kt`
- `app/.../ElectricSheepApplication.kt`
- `app/.../data/DataModule.kt`
- `app/build.gradle.kts`, `build.gradle.kts`

**If modifying shared files:**
1. Check `docs/development/AGENT_COORDINATION.md` for conflicts
2. Document your changes in coordination doc
3. Consider using git worktree for isolation
4. Coordinate with other agents if needed

## Workflow Enforcement

**When user asks you to make changes:**

1. **MANDATORY: Run pre-work check first:**
   ```bash
   ./scripts/pre-work-check.sh
   ```
   This will:
   - Verify you're not on main
   - Check for remote updates
   - Run coordination checks
   - Discover relevant rules
   - Identify available tools

2. **If on main, STOP and create branch:**
   ```bash
   git checkout -b feature/<task-description>
   # Or for file system isolation:
   ./scripts/create-worktree.sh <task-name>
   ```

3. **Discover relevant rules:**
   ```bash
   ./scripts/discover-rules.sh <task-keyword>
   ```
   Read the suggested rules and reference them explicitly in your implementation.

4. **Before modifying files, check coordination:**
   ```bash
   ./scripts/check-agent-coordination.sh
   ```
   This will:
   - Check for shared file conflicts
   - Warn about high-risk files
   - Suggest worktree usage if needed

5. **After work, update coordination doc:**
   - Mark work as "In Progress" or "Complete"
   - List files you modified

## Commit Rules

**Before committing:**

1. ✅ **Pre-commit hook runs automatically** - Prevents commits to main
2. ✅ Verify you're on a feature branch (not `main`)
3. ✅ Use descriptive commit messages
4. ✅ Keep commits atomic (one logical change)
5. ✅ Run tests: `./gradlew test` (all tests must pass)

**Commit message format:**
```
<type>: <description>

[optional body]
[optional: AI-generated code indicator]
```

**Types:** `feat`, `fix`, `refactor`, `docs`, `test`, `chore`

**AI Code Provenance (Optional but Recommended):**
- If code was AI-generated: Add `[AI]` prefix or note in body
- If code was AI-generated with human edits: Note significant edits
- Example: `feat: [AI] Add user authentication flow` or `feat: Add feature (AI-generated, human-reviewed)`

**Research shows**: Tracking AI code provenance improves learning and prompt effectiveness

**CRITICAL: Commit Frequently (Safety Net)**
- ✅ **Commit frequently** - Every 15-30 minutes, even if work is incomplete
- ✅ **Use WIP commits** - `git commit -m "WIP: <description>"` for incomplete work
- ✅ **Commit after each logical step** - Don't wait for feature completion
- ✅ **Commit before risky operations** - Before refactoring, large changes, experiments
- ✅ **Local commits only** - No need to push every commit (push when ready for review)

**See:** `.cursor/rules/frequent-commits.mdc` for complete frequent commit guidelines

## Related Rules
- `.cursor/rules/branch-synchronization.mdc` - **CRITICAL**: Branch sync and conflict prevention
- `.cursor/rules/frequent-commits.mdc` - Commit frequency guidelines
- `.cursor/rules/repository-maintenance.mdc` - Cleanup procedures
- `.cursor/rules/cicd.mdc` - CI/CD workflow

## Error Prevention

**STOP and fix if:**
- ❌ On `main` branch → Create feature branch
- ❌ Tests failing → Fix before proceeding
- ❌ Shared file conflict → Check coordination, use worktree
- ❌ Branch name doesn't follow convention → Rename branch

## Examples

**See code examples:**
- Branch creation: `scripts/create-worktree.sh`
- Pre-work validation: `scripts/pre-work-check.sh`
- Cleanup automation: `scripts/post-merge-cleanup.sh`

**See documentation:**
- Multi-agent workflow: `docs/development/MULTI_AGENT_WORKFLOW.md`
- Coordination: `docs/development/AGENT_COORDINATION.md`
