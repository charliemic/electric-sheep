---
alwaysApply: true
---

# Branch Isolation and Multi-Agent Workflow Rules

## CRITICAL: Never Work on Main Branch

**Before making ANY changes, you MUST:**

1. **Check current branch:**
   ```bash
   git status
   # or
   git branch
   ```

2. **If on `main` branch, IMMEDIATELY create a feature branch:**
   ```bash
   git checkout -b feature/<task-description>
   # Or use git worktree for file system isolation:
   # git worktree add ../electric-sheep-<task-name> -b feature/<task-name>
   ```

3. **Never commit directly to `main`** - All changes must go through feature branches.

## Branch Naming Convention

**Required format:** `<type>/<task-description>`

**Types:**
- `feature/` - New functionality
- `fix/` - Bug fixes  
- `refactor/` - Code refactoring
- `docs/` - Documentation only
- `test/` - Test improvements

**Examples:**
- ✅ `feature/test-helpers`
- ✅ `feature/env-switch`
- ✅ `fix/login-bug`
- ✅ `refactor/component-cleanup`
- ❌ `feature/my-feature` (too vague - be descriptive)
- ❌ `test-helpers` (missing type prefix)

**Note:** Agents are ephemeral - branch names should describe the task, not identify the agent.

## File System Isolation (REQUIRED for Shared Files)

**When modifying shared files, you MUST use git worktrees:**

```bash
# Create isolated worktree (MANDATORY for shared files)
git worktree add ../electric-sheep-<task-name> -b feature/<task-name>
cd ../electric-sheep-<task-name>
# Work in complete isolation
```

**Benefits:**
- Complete file system isolation
- No conflicts with other agents
- Easy cleanup after merge
- Prevents lost work and collisions

**When worktree is REQUIRED:**
- Modifying ANY file matching HIGH RISK patterns (see File Coordination section)
- Multiple agents might modify the same file
- File is in shared files list

**When worktree is RECOMMENDED:**
- Modifying MEDIUM-HIGH or MEDIUM RISK files
- Working on large features that span multiple files
- Uncertain if other agents are working on related files

## Pre-Work Checklist (MANDATORY)

Before starting any work, you MUST:

1. ✅ **Verify NOT on main branch** - Check `git status`
2. ✅ **Create feature branch** - Use proper naming convention
3. ✅ **Check if files are shared** - Review shared files patterns (see File Coordination section)
4. ✅ **Use worktree if modifying shared files** - MANDATORY for HIGH RISK files, recommended for others
5. ✅ **Pull latest main** - `git pull origin main`
6. ✅ **Check coordination doc** - Read `docs/development/AGENT_COORDINATION.md`
7. ✅ **Document your work** - Update coordination doc with your planned changes

## File Coordination

**Before modifying files, check coordination:**

**Shared files (REQUIRE worktree isolation):**

**HIGH RISK - MUST use worktree:**
- `app/.../ui/screens/**/*Screen.kt` (ALL screen files - multiple agents modify screens)
- `app/.../ui/screens/**/*ViewModel.kt` (ALL ViewModel files - shared state management)
- `app/.../ui/navigation/*.kt` (Navigation files - central routing, adding screens)
- `app/.../*Application.kt` (Application class - central initialization, DI setup)
- `app/.../**/*Module.kt` (DI module files - dependency injection setup)
- `**/*.gradle.kts` (Build files - dependency management)
- `gradle.properties` (Gradle properties - build configuration)
- `settings.gradle.kts` (Settings file - project structure)

**MEDIUM-HIGH RISK - Should use worktree:**
- `app/.../ui/components/*.kt` (Shared UI components - design system changes)
- `app/.../**/*Manager.kt` (Manager classes - shared services)
- `app/.../**/*Provider.kt` (Provider classes - shared providers)

**MEDIUM RISK - Consider worktree:**
- `app/.../data/repository/*Repository.kt` (Repository files - data access layer)
- `app/.../ui/theme/*.kt` (Theme files - shared styling)
- `app/.../config/*.kt` (Config files - shared configuration)
- `app/.../**/*Factory.kt` (Factory files - ViewModel factories)
- `app/.../MainActivity.kt` (Main activity - app entry point)

**If modifying ANY shared file:**
1. **MUST** check `docs/development/AGENT_COORDINATION.md` for conflicts
2. **MUST** use git worktree for file system isolation (no exceptions for HIGH RISK files)
3. **MUST** document your changes in coordination doc
4. **MUST** coordinate with other agents if conflicts detected

**Collision Consequences:**
- ❌ Changes may be lost or overwritten
- ❌ Manual conflict resolution required
- ❌ Work duplication and wasted effort
- ✅ Use worktree to prevent all of these issues

## Workflow Enforcement

**When user asks you to make changes:**

1. **First, check branch:**
   ```bash
   git branch --show-current
   ```

2. **If on main, STOP and create branch:**
   ```bash
   git checkout -b feature/<task-description>
   # Or for file system isolation:
   # git worktree add ../electric-sheep-<task-name> -b feature/<task-name>
   ```

3. **Before modifying files, check coordination:**
   - Read `docs/development/AGENT_COORDINATION.md`
   - Check if files match shared file patterns (see File Coordination section)
   - **If modifying HIGH RISK shared files, MUST use worktree** (no exceptions)
   - Verify no conflicts with other agents
   - Document your planned changes
   - Use git worktree for shared files (mandatory for HIGH RISK, recommended for others)

4. **After work, update coordination doc:**
   - Mark work as "In Progress" or "Complete"
   - List files you modified

## Commit Rules

**Before committing:**

1. ✅ Verify you're on a feature branch (not `main`)
2. ✅ Use descriptive commit messages
3. ✅ Keep commits atomic (one logical change)
4. ✅ Run tests if applicable

**Commit message format:**
```
<type>: <description>

[optional body]
```

**Types:** `feat`, `fix`, `refactor`, `docs`, `test`, `chore`

## Error Prevention

**If you detect these conditions, STOP and fix:**

- ❌ User is on `main` branch → Create feature branch immediately
- ❌ Branch name doesn't follow convention → Rename branch
- ❌ Modifying HIGH RISK shared file without worktree → Create worktree immediately
- ❌ Modifying shared file without coordination → Check coordination doc first
- ❌ Tests failing → Fix tests before proceeding
- ❌ Uncommitted work on `main` → Move to feature branch
- ❌ File system conflicts → Use git worktree for isolation
- ❌ File matches shared pattern but no worktree → Create worktree before proceeding

## Worktree Cleanup (MANDATORY)

**After branch is merged or deleted, you MUST:**

1. **Remove worktree immediately:**
   ```bash
   # From main repository (not from within the worktree)
   cd /path/to/main/repo
   git worktree remove ../electric-sheep-<task-name>
   ```

2. **If worktree directory was already deleted:**
   ```bash
   # Prune stale worktree references
   git worktree prune
   ```

3. **Verify cleanup:**
   ```bash
   # List all worktrees - should not show merged/deleted branches
   git worktree list
   ```

**When to clean up:**
- ✅ **Immediately after branch is merged** - Remove worktree right away
- ✅ **When branch is deleted** - Remove worktree if branch is abandoned
- ✅ **Before starting new work** - Check for orphaned worktrees and clean them up

**Cleanup Checklist:**
- [ ] Branch merged or deleted
- [ ] Worktree removed: `git worktree remove ../electric-sheep-<task-name>`
- [ ] Verify with: `git worktree list`
- [ ] Update coordination doc (mark work as complete)

**CRITICAL:** Orphaned worktrees waste disk space and can cause confusion. Always clean up after your work is merged.

## Multi-Agent Coordination

**Always:**
- Check `docs/development/AGENT_COORDINATION.md` before starting
- Document your work in coordination doc
- Update coordination doc when work status changes
- Coordinate if files overlap with other agents
- Use git worktree for file system isolation when needed
- **Remove worktree after branch is merged/deleted**

**See:** `docs/development/MULTI_AGENT_WORKFLOW.md` for complete guidelines
