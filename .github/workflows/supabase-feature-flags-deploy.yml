name: Deploy Feature Flag Values to Supabase

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'feature-flags/**'
      - '.github/workflows/supabase-feature-flags-deploy.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'feature-flags/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to (staging or production)'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'

jobs:
  validate-flags:
    name: Validate Feature Flags
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Validate flags.yaml syntax
        run: |
          if [ ! -f "feature-flags/flags.yaml" ]; then
            echo "Error: feature-flags/flags.yaml not found"
            exit 1
          fi
          
          # Check YAML syntax
          yq eval '.flags' feature-flags/flags.yaml > /dev/null || {
            echo "Error: Invalid YAML syntax in flags.yaml"
            exit 1
          }
          
          # Validate flag structure
          FLAG_COUNT=$(yq '.flags | length' feature-flags/flags.yaml)
          echo "Found $FLAG_COUNT flag(s)"
          
          MISSING_CONFIG_FLAGS=()
          
          for i in $(seq 0 $((FLAG_COUNT - 1))); do
            KEY=$(yq ".flags[$i].key" feature-flags/flags.yaml)
            VALUE_TYPE=$(yq ".flags[$i].value_type" feature-flags/flags.yaml)
            ENABLED=$(yq ".flags[$i].enabled" feature-flags/flags.yaml)
            
            # Validate required fields
            if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
              echo "Error: Flag at index $i is missing 'key'"
              exit 1
            fi
            
            if [ -z "$VALUE_TYPE" ] || [ "$VALUE_TYPE" = "null" ]; then
              echo "Error: Flag '$KEY' is missing 'value_type'"
              exit 1
            fi
            
            if [ "$VALUE_TYPE" != "boolean" ] && [ "$VALUE_TYPE" != "string" ] && [ "$VALUE_TYPE" != "int" ]; then
              echo "Error: Flag '$KEY' has invalid value_type: $VALUE_TYPE (must be 'boolean', 'string', or 'int')"
              exit 1
            fi
            
            # Validate value matches type
            if [ "$VALUE_TYPE" = "boolean" ]; then
              VALUE=$(yq ".flags[$i].boolean_value" feature-flags/flags.yaml)
              if [ "$VALUE" != "true" ] && [ "$VALUE" != "false" ]; then
                echo "Error: Flag '$KEY' has invalid boolean_value: $VALUE"
                exit 1
              fi
            elif [ "$VALUE_TYPE" = "string" ]; then
              VALUE=$(yq ".flags[$i].string_value" feature-flags/flags.yaml)
              if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
                echo "Error: Flag '$KEY' is missing 'string_value'"
                exit 1
              fi
            elif [ "$VALUE_TYPE" = "int" ]; then
              VALUE=$(yq ".flags[$i].int_value" feature-flags/flags.yaml)
              if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
                echo "Error: Flag '$KEY' is missing 'int_value'"
                exit 1
              fi
            fi
            
            # Check if flag has corresponding BuildConfig field
            CONFIG_KEY=$(echo "$KEY" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
            if [ "$VALUE_TYPE" = "boolean" ]; then
              CONFIG_FIELD="${CONFIG_KEY}_MODE"
            else
              CONFIG_FIELD="${CONFIG_KEY}_VALUE"
            fi
            
            if ! grep -qiE "buildConfigField.*[\"']${CONFIG_FIELD}[\"']" app/build.gradle.kts; then
              MISSING_CONFIG_FLAGS+=("$KEY (expected BuildConfig field: $CONFIG_FIELD)")
            fi
            
            echo "✓ Validated flag: $KEY ($VALUE_TYPE)"
          done
          
          # Report missing BuildConfig fields
          if [ ${#MISSING_CONFIG_FLAGS[@]} -gt 0 ]; then
            echo ""
            echo "⚠️  Warning: The following flags are missing BuildConfig fallback values:"
            for flag in "${MISSING_CONFIG_FLAGS[@]}"; do
              echo "   - $flag"
            done
            echo ""
            echo "To fix: Add the corresponding buildConfigField in app/build.gradle.kts"
            exit 1
          fi
          
          echo "All flags validated successfully (including BuildConfig fallback checks)"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/develop' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging')
    needs: validate-flags
    environment:
      name: staging
    # Following Supabase docs pattern: https://supabase.com/docs/guides/deployment/managing-environments
    # Using existing GitHub secret names while maintaining docs pattern for env vars
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install required tools
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Link to staging project
        run: supabase link --project-ref $SUPABASE_PROJECT_ID
      
      - name: Get database connection string
        id: db-url
        run: |
          # Use connection pooler (Supavisor) which supports IPv4
          # Direct connections use IPv6 only, which GitHub Actions doesn't support
          # Pooler format: postgresql://postgres.[PROJECT_ID]:[PASSWORD]@[REGION].pooler.supabase.com:6543/postgres
          # URL-encode the password to handle special characters
          ENCODED_PASSWORD=$(printf '%s' "$SUPABASE_DB_PASSWORD" | jq -sRr @uri)
          
          # Get region from Supabase Management API
          # If region secret is set, use it; otherwise try to get from API
          REGION="${SUPABASE_REGION:-}"
          if [ -z "$REGION" ]; then
            echo "Getting region from Supabase API..."
            REGION=$(curl -s -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              "https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_ID}" \
              | jq -r '.region // "us-west-1"' 2>/dev/null || echo "us-west-1")
          fi
          
          # Use connection pooler with region
          DB_URL="postgresql://postgres.${SUPABASE_PROJECT_ID}:${ENCODED_PASSWORD}@aws-0-${REGION}.pooler.supabase.com:6543/postgres"
          echo "Using connection pooler in region: $REGION"
          echo "db_url=$DB_URL" >> $GITHUB_OUTPUT
      
      - name: Sync feature flags
        env:
          SUPABASE_DB_URL: ${{ steps.db-url.outputs.db_url }}
        run: |
          chmod +x scripts/sync-feature-flags.sh
          ./scripts/sync-feature-flags.sh --verbose feature-flags/flags.yaml
      
      - name: Verify deployment
        run: |
          echo "Feature flags deployed successfully to staging"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    needs: validate-flags
    environment:
      name: production
    # Following Supabase docs pattern: https://supabase.com/docs/guides/deployment/managing-environments
    # Using existing GitHub secret names while maintaining docs pattern for env vars
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_REF }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install required tools
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Link to production project
        run: supabase link --project-ref $SUPABASE_PROJECT_ID
      
      - name: Get database connection string
        id: db-url
        run: |
          # Use connection pooler (Supavisor) which supports IPv4
          # Direct connections use IPv6 only, which GitHub Actions doesn't support
          # Pooler format: postgresql://postgres.[PROJECT_ID]:[PASSWORD]@[REGION].pooler.supabase.com:6543/postgres
          # URL-encode the password to handle special characters
          ENCODED_PASSWORD=$(printf '%s' "$SUPABASE_DB_PASSWORD" | jq -sRr @uri)
          
          # Get region from Supabase Management API
          # If region secret is set, use it; otherwise try to get from API
          REGION="${SUPABASE_REGION:-}"
          if [ -z "$REGION" ]; then
            echo "Getting region from Supabase API..."
            REGION=$(curl -s -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              "https://api.supabase.com/v1/projects/${SUPABASE_PROJECT_ID}" \
              | jq -r '.region // "us-west-1"' 2>/dev/null || echo "us-west-1")
          fi
          
          # Use connection pooler with region
          DB_URL="postgresql://postgres.${SUPABASE_PROJECT_ID}:${ENCODED_PASSWORD}@aws-0-${REGION}.pooler.supabase.com:6543/postgres"
          echo "Using connection pooler in region: $REGION"
          echo "db_url=$DB_URL" >> $GITHUB_OUTPUT
      
      - name: Sync feature flags
        env:
          SUPABASE_DB_URL: ${{ steps.db-url.outputs.db_url }}
        run: |
          chmod +x scripts/sync-feature-flags.sh
          ./scripts/sync-feature-flags.sh --verbose feature-flags/flags.yaml
      
      - name: Verify deployment
        run: |
          echo "Feature flags deployed successfully to production"

  preview-flags:
    name: Preview Feature Flags (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: validate-flags
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Show flag changes
        run: |
          echo "## Feature Flag Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Flags that will be deployed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          yq '.flags' feature-flags/flags.yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
