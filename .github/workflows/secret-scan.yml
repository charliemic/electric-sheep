name: Secret Scanning

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  schedule:
    # Weekly full-history scan on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  secret-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Fast timeout - secret scan should be quick
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # Full history for scheduled scans, shallow for PRs (faster)
          fetch-depth: ${{ github.event_name == 'schedule' && 0 || 1 }}
      
      - name: Validate Gitleaks Config
        run: |
          # Validate .gitleaks.toml syntax
          if ! command -v gitleaks &> /dev/null; then
            echo "‚ö†Ô∏è  Gitleaks CLI not available, skipping config validation"
            exit 0
          fi
          # Try to parse config (basic validation)
          if [ -f .gitleaks.toml ]; then
            echo "‚úÖ Gitleaks config file exists"
            # Basic TOML syntax check (if toml-cli available)
            if command -v toml-cli &> /dev/null; then
              toml-cli validate .gitleaks.toml && echo "‚úÖ Gitleaks config syntax valid"
            else
              echo "‚ÑπÔ∏è  toml-cli not available, skipping syntax validation"
            fi
          else
            echo "‚ùå Gitleaks config file not found"
            exit 1
          fi
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          exit-code: 1
          no-git: false
          verbose: false  # Less verbose for speed
          redact: true
          severity: high
      
      - name: Comment PR with findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## üîí Secret Scanning Alert\n\n‚ö†Ô∏è **Secrets detected in this PR!**\n\nPlease remove any secrets, API keys, passwords, or credentials from the code.\n\n**Next steps:**\n1. Remove the secret from the code\n2. If the secret was committed, rotate it immediately\n3. Use GitHub Secrets for CI/CD\n4. Use environment variables for local development\n\nSee [Security Guidelines](.cursor/rules/security.mdc) for more information.'
            });
