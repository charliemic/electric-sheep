name: Build and Test Android App (Kotlin/Gradle)

on:
  push:
    branches: ['**']  # Run on all branches
  pull_request:
    branches: ['**']  # Run on PRs to any branch

# Permissions required for path filtering action
permissions:
  contents: read
  pull-requests: read

jobs:
  # Detect which files changed to determine which jobs to run
  changes:
    runs-on: ubuntu-latest
    outputs:
      app-code: ${{ steps.filter.outputs.app-code }}
      docs: ${{ steps.filter.outputs.docs }}
      scripts: ${{ steps.filter.outputs.scripts }}
      emulator-scripts: ${{ steps.filter.outputs.emulator-scripts }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect changed files
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            app-code:
              - 'app/**'
              - 'build.gradle*'
              - 'gradle/**'
              - 'settings.gradle*'
              - 'gradlew*'
            docs:
              - 'docs/**'
              - '*.md'
              - 'README.md'
            scripts:
              - 'scripts/**'
            emulator-scripts:
              - 'scripts/emulator-*.sh'
              - 'scripts/tests/**'
              - 'docs/development/EMULATOR_MANAGEMENT*.md'
              - 'Makefile'
            workflows:
              - '.github/workflows/**'
          list-files: shell

  setup:
    needs: changes
    # Only run setup if app code changed (needed for lint, test, build jobs)
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Cache Gradle dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Cache Android build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/build-cache
          ${{ github.workspace }}/.gradle
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-android-

  lint:
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Lint check
      run: ./gradlew lint --stacktrace
      continue-on-error: false

    - name: Upload lint results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: app/build/reports/lint-results*.html
        retention-days: 7

  accessibility:
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Accessibility lint check
      run: ./gradlew lint --stacktrace -Pandroid.lint.checkAccessibility=true
      continue-on-error: false

  test:
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Run unit tests
      run: ./gradlew test --stacktrace
      continue-on-error: false

    - name: List test result files (debug)
      if: always()
      run: |
        echo "Checking for test XML files..."
        find app/build/test-results -name "*.xml" -type f || echo "No XML files found"
        ls -la app/build/test-results/ || echo "test-results directory does not exist"

    - name: Publish Test Results
      if: always()
      continue-on-error: true
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: |
          app/build/test-results/**/*.xml
        check_name: Unit Test Results
        report_individual_runs: true
        deduplicate_classes_by_file_name: true
        compare_to_earlier_commit: false

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 7

  build-debug:
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Restore Android build cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/build-cache
          ${{ github.workspace }}/.gradle
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-android-

    - name: Build debug APK
      run: ./gradlew assembleDebug --stacktrace
      continue-on-error: false

  build-release:
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Restore Android build cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/build-cache
          ${{ github.workspace }}/.gradle
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-android-

    - name: Build release AAB
      run: ./gradlew bundleRelease --stacktrace
      continue-on-error: false

  # Emulator Management Scripts Tests
  # Non-blocking: failures don't prevent merge
  # Only runs if emulator management scripts changed
  test-emulator-scripts:
    needs: changes
    # Only run if emulator scripts changed
    if: needs.changes.outputs.emulator-scripts == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking: don't fail the build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Install jq
        run: |
          sudo apt-get install -y jq

      - name: Verify dependencies
        run: |
          bats --version
          jq --version
          bash --version

      - name: Make test scripts executable
        run: |
          chmod +x scripts/tests/*.sh
          chmod +x scripts/tests/*.bats
          chmod +x scripts/emulator-*.sh

      - name: Run emulator management tests
        run: |
          ./scripts/tests/run_tests.sh --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-script-test-results
          path: |
            scripts/tests/*.log
            scripts/tests/test-results/
          retention-days: 7
          if-no-files-found: ignore
