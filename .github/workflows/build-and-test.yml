name: Build and Test Android App (Kotlin/Gradle)

on:
  push:
    branches: ['**']  # Run on all branches
  pull_request:
    branches: ['**']  # Run on PRs to any branch

# Permissions required for path filtering action and status checks
permissions:
  contents: read
  pull-requests: read
  checks: write  # Required to create status checks

jobs:
  # Detect which files changed to determine which jobs to run
  changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      app-code: ${{ steps.filter.outputs.app-code }}
      docs: ${{ steps.filter.outputs.docs }}
      scripts: ${{ steps.filter.outputs.scripts }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect changed files
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            app-code:
              - 'app/**'
              - 'build.gradle*'
              - 'gradle/**'
              - 'settings.gradle*'
              - 'gradlew*'
            docs:
              - 'docs/**'
              - '*.md'
              - 'README.md'
            scripts:
              - 'scripts/**'
            workflows:
              - '.github/workflows/**'
          list-files: shell

  setup:
    name: Setup Build Environment
    needs: changes
    # Only run setup if app code changed (needed for lint, test, build jobs)
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Cache Gradle dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Cache Android build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/build-cache
          ${{ github.workspace }}/.gradle
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-android-

  lint:
    name: Run Lint Checks
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Lint check
      run: ./gradlew lint --stacktrace
      continue-on-error: false

    - name: Upload lint results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: app/build/reports/lint-results*.html
        retention-days: 7

  accessibility:
    name: Run Accessibility Checks
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Accessibility lint check
      run: ./gradlew lint --stacktrace -Pandroid.lint.checkAccessibility=true
      continue-on-error: false

  test:
    name: Run Unit Tests
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Run unit tests
      run: ./gradlew test --stacktrace
      continue-on-error: false

    - name: List test result files (debug)
      if: always()
      run: |
        echo "Checking for test XML files..."
        find app/build/test-results -name "*.xml" -type f || echo "No XML files found"
        ls -la app/build/test-results/ || echo "test-results directory does not exist"

    - name: Publish Test Results
      if: always()
      continue-on-error: true
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: |
          app/build/test-results/**/*.xml
        check_name: Unit Test Results
        report_individual_runs: true
        deduplicate_classes_by_file_name: true
        compare_to_earlier_commit: false

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 7

  build-debug:
    name: Build Debug APK
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Restore Android build cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/build-cache
          ${{ github.workspace }}/.gradle
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-android-

    - name: Build debug APK
      run: ./gradlew assembleDebug --stacktrace
      continue-on-error: false

  build-release:
    name: Build Release AAB
    needs: [changes, setup]
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true

    - name: Restore Gradle cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Restore Android build cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/build-cache
          ${{ github.workspace }}/.gradle
        key: ${{ runner.os }}-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-android-

    - name: Build release AAB
      run: ./gradlew bundleRelease --stacktrace
      continue-on-error: false

  # Final status check - required by branch protection
  # This job creates the "ci-status" check that branch protection requires
  ci-status:
    name: CI Status Check
    needs: [changes, lint, accessibility, test, build-debug, build-release]
    # Always run if any of the dependent jobs ran (they only run if app-code changed)
    # Use a more permissive condition to ensure the job runs when needed
    if: always() && (needs.changes.outputs.app-code == 'true' || needs.lint.result != 'skipped' || needs.test.result != 'skipped')
    runs-on: ubuntu-latest
    permissions:
      checks: write  # Required to create status checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create ci-status check
        uses: actions/github-script@v7
        with:
          script: |
            // Determine if all required jobs succeeded or were skipped
            const results = {
              lint: '${{ needs.lint.result }}',
              accessibility: '${{ needs.accessibility.result }}',
              test: '${{ needs.test.result }}',
              buildDebug: '${{ needs.build-debug.result }}',
              buildRelease: '${{ needs.build-release.result }}'
            };
            
            const allPassed = Object.values(results).every(
              result => result === 'success' || result === 'skipped'
            );
            
            const conclusion = allPassed ? 'success' : 'failure';
            const message = allPassed 
              ? 'All CI checks passed successfully'
              : 'One or more CI checks failed';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'ci-status',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: message,
                summary: allPassed 
                  ? 'All required CI checks (lint, accessibility, test, build-debug, build-release) have completed successfully.'
                  : 'One or more required CI checks failed. Please review the workflow run for details.'
              }
            });
            
            // Exit with error if checks failed
            if (!allPassed) {
              core.setFailed(message);
            }