name: Dependency Security Scan

on:
  push:
    branches: [main, develop]
    paths:
      # Dependency files (always high risk)
      - '**/*.gradle*'
      - '**/gradle-wrapper.properties'
      - 'package.json'
      - 'package-lock.json'
      # High-risk code changes (auth, network, data)
      - 'app/**/auth/**'
      - 'app/**/remote/**'
      - 'app/**/data/**'
      - 'app/**/repository/**'
      - 'build.gradle*'
  pull_request:
    branches: [main, develop]
    paths:
      # Dependency files (always high risk)
      - '**/*.gradle*'
      - '**/gradle-wrapper.properties'
      - 'package.json'
      - 'package-lock.json'
      # High-risk code changes (auth, network, data)
      - 'app/**/auth/**'
      - 'app/**/remote/**'
      - 'app/**/data/**'
      - 'app/**/repository/**'
      - 'build.gradle*'
  schedule:
    # Weekly scan on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  dependency-scan:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced since we're only running on high-risk changes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
      
      - name: Cache OWASP Dependency-Check database
        uses: actions/cache@v3
        id: depcheck-cache
        with:
          path: |
            ~/.dependency-check/data
            ~/.dependency-check/cache
          key: ${{ runner.os }}-depcheck-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-depcheck-
      
      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'electric-sheep'
          path: '.'
          format: 'HTML'
          format: 'JSON'
          format: 'SARIF'
          args: >
            --failOnCVSS 7
            --enableRetired
            --enableExperimental
            --out reports
            --scan app/
            --scan scripts/
            --nvdApiKey ${{ secrets.NVD_API_KEY }}
            --data ${{ steps.depcheck-cache.outputs.cache-hit == 'true' && '~/.dependency-check/data' || '' }}
        continue-on-error: true
      
      - name: Upload dependency check results (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-html
          path: reports/dependency-check-report.html
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload dependency check results (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-json
          path: reports/dependency-check-report.json
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload SARIF results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/dependency-check-report.sarif
          wait-for-processing: false  # Don't wait, upload async for speed
          if-no-files-found: ignore
      
      - name: Comment PR with vulnerability summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const reportPath = 'reports/dependency-check-report.json';
            
            if (!fs.existsSync(reportPath)) {
              console.log('No dependency check report found');
              return;
            }
            
            try {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const dependencies = report.dependencies || [];
              
              const critical = dependencies.filter(d => 
                d.vulnerabilities && d.vulnerabilities.some(v => 
                  v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 9.0
                )
              );
              
              const high = dependencies.filter(d => 
                d.vulnerabilities && d.vulnerabilities.some(v => 
                  v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 7.0 && parseFloat(v.cvssv3.baseScore) < 9.0
                )
              );
              
              if (critical.length === 0 && high.length === 0) {
                console.log('No critical or high vulnerabilities found');
                return;
              }
              
              let comment = '## ðŸ”’ Dependency Security Scan Results\n\n';
              
              if (critical.length > 0) {
                comment += `### âš ï¸ Critical Vulnerabilities (${critical.length})\n\n`;
                critical.slice(0, 5).forEach(dep => {
                  const vulns = dep.vulnerabilities.filter(v => 
                    v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 9.0
                  );
                  comment += `- **${dep.fileName}**: ${vulns.length} critical vulnerability(ies)\n`;
                  vulns.slice(0, 2).forEach(v => {
                    const desc = v.description ? v.description.substring(0, 100) : 'No description';
                    comment += `  - ${v.name}: ${desc}...\n`;
                  });
                });
                comment += '\n';
              }
              
              if (high.length > 0) {
                comment += `### âš ï¸ High Vulnerabilities (${high.length})\n\n`;
                high.slice(0, 5).forEach(dep => {
                  const vulns = dep.vulnerabilities.filter(v => 
                    v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 7.0 && parseFloat(v.cvssv3.baseScore) < 9.0
                  );
                  comment += `- **${dep.fileName}**: ${vulns.length} high vulnerability(ies)\n`;
                });
                comment += '\n';
              }
              
              comment += 'ðŸ“Š Full report available in workflow artifacts.\n';
              comment += 'ðŸ” Review and update dependencies before merging.\n';
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Error parsing dependency check report:', error.message);
            }
      
      - name: Fail if critical vulnerabilities found
        if: steps.depcheck.outcome == 'failure'
        run: |
          echo "âŒ Critical vulnerabilities detected (CVSS >= 7.0)"
          echo "Please review the dependency check report and update vulnerable dependencies."
          exit 1
