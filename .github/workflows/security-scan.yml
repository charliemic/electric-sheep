name: Security Scanning

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  schedule:
    # Weekly comprehensive scan on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # Detect which files changed to determine which security jobs to run
  changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      app-code: ${{ steps.filter.outputs.app-code }}
      dependencies: ${{ steps.filter.outputs.dependencies }}
      high-risk: ${{ steps.filter.outputs.high-risk }}
      all-files: ${{ steps.filter.outputs.all }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect changed files
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            app-code:
              - 'app/**'
              - 'build.gradle*'
            dependencies:
              - '**/*.gradle*'
              - '**/gradle-wrapper.properties'
              - 'package.json'
              - 'package-lock.json'
            high-risk:
              # Dependency changes (always high risk)
              - '**/*.gradle*'
              - '**/gradle-wrapper.properties'
              - 'package.json'
              - 'package-lock.json'
              # Authentication/Authorization (critical security)
              - 'app/**/auth/**'
              - 'app/**/Auth*.kt'
              # Network/API code (attack surface)
              - 'app/**/remote/**'
              - 'app/**/network/**'
              - 'app/**/api/**'
              # Data handling (data exposure risk)
              - 'app/**/data/**'
              - 'app/**/repository/**'
              - 'app/**/database/**'
              # Security-related code
              - 'app/**/security/**'
              - 'app/**/Security*.kt'
              # Build configuration (affects dependencies)
              - 'build.gradle*'
              - 'gradle.properties'
              - 'settings.gradle*'
          list-files: shell

  # Secret scanning - runs on all changes, very fast
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    needs: changes
    # Always run (secrets can be in any file)
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Full history for scheduled scans, shallow for PRs (faster)
          fetch-depth: ${{ github.event_name == 'schedule' && 0 || 1 }}
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          exit-code: 1
          no-git: false
          verbose: false  # Less verbose for speed
          redact: true
          severity: high
      
      - name: Comment PR with findings
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ”’ Secret Scanning Alert\n\nâš ï¸ **Secrets detected in this PR!**\n\nPlease remove any secrets, API keys, passwords, or credentials from the code.\n\n**Next steps:**\n1. Remove the secret from the code\n2. If the secret was committed, rotate it immediately\n3. Use GitHub Secrets for CI/CD\n4. Use environment variables for local development\n\nSee [Security Guidelines](.cursor/rules/security.mdc) for more information.'
            });

  # Dependency scanning - only runs on HIGH-RISK changes or schedule
  # This is the longest job (5-8 min), so we only run it when necessary
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    needs: changes
    # Only run on high-risk changes (dependencies, auth, network, data) or schedule/manual
    # This keeps pipelines under 5 minutes for low-risk changes
    if: needs.changes.outputs.high-risk == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 10  # Reduced timeout since we're being selective
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'  # Automatic Gradle caching
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
      
      - name: Cache OWASP Dependency-Check database
        uses: actions/cache@v3
        id: depcheck-cache
        with:
          path: |
            ~/.dependency-check/data
            ~/.dependency-check/cache
          key: ${{ runner.os }}-depcheck-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-depcheck-
      
      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'electric-sheep'
          path: '.'
          format: 'HTML'
          format: 'JSON'
          format: 'SARIF'
          args: >
            --failOnCVSS 7
            --enableRetired
            --enableExperimental
            --out reports
            --scan app/
            --scan scripts/
            --nvdApiKey ${{ secrets.NVD_API_KEY }}
            --data ${{ steps.depcheck-cache.outputs.cache-hit == 'true' && '~/.dependency-check/data' || '' }}
        continue-on-error: true
      
      - name: Upload dependency check results (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-html
          path: reports/dependency-check-report.html
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload dependency check results (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-json
          path: reports/dependency-check-report.json
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Upload SARIF results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/dependency-check-report.sarif
          wait-for-processing: false  # Don't wait, upload async
          if-no-files-found: ignore
      
      - name: Comment PR with vulnerability summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/dependency-check-report.json';
            
            if (!fs.existsSync(reportPath)) {
              console.log('No dependency check report found');
              return;
            }
            
            try {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const dependencies = report.dependencies || [];
              
              const critical = dependencies.filter(d => 
                d.vulnerabilities && d.vulnerabilities.some(v => 
                  v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 9.0
                )
              );
              
              const high = dependencies.filter(d => 
                d.vulnerabilities && d.vulnerabilities.some(v => 
                  v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 7.0 && parseFloat(v.cvssv3.baseScore) < 9.0
                )
              );
              
              if (critical.length === 0 && high.length === 0) {
                console.log('No critical or high vulnerabilities found');
                return;
              }
              
              let comment = '## ðŸ”’ Dependency Security Scan Results\n\n';
              
              if (critical.length > 0) {
                comment += `### âš ï¸ Critical Vulnerabilities (${critical.length})\n\n`;
                critical.slice(0, 5).forEach(dep => {
                  const vulns = dep.vulnerabilities.filter(v => 
                    v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 9.0
                  );
                  comment += `- **${dep.fileName}**: ${vulns.length} critical vulnerability(ies)\n`;
                  vulns.slice(0, 2).forEach(v => {
                    const desc = v.description ? v.description.substring(0, 100) : 'No description';
                    comment += `  - ${v.name}: ${desc}...\n`;
                  });
                });
                comment += '\n';
              }
              
              if (high.length > 0) {
                comment += `### âš ï¸ High Vulnerabilities (${high.length})\n\n`;
                high.slice(0, 5).forEach(dep => {
                  const vulns = dep.vulnerabilities.filter(v => 
                    v.cvssv3 && parseFloat(v.cvssv3.baseScore) >= 7.0 && parseFloat(v.cvssv3.baseScore) < 9.0
                  );
                  comment += `- **${dep.fileName}**: ${vulns.length} high vulnerability(ies)\n`;
                });
                comment += '\n';
              }
              
              comment += 'ðŸ“Š Full report available in workflow artifacts.\n';
              comment += 'ðŸ” Review and update dependencies before merging.\n';
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Error parsing dependency check report:', error.message);
            }
      
      - name: Fail if critical vulnerabilities found
        if: steps.depcheck.outcome == 'failure'
        run: |
          echo "âŒ Critical vulnerabilities detected (CVSS >= 7.0)"
          echo "Please review the dependency check report and update vulnerable dependencies."
          exit 1

  # Security linting - only runs when app code changes
  security-lint:
    name: Security Linting
    runs-on: ubuntu-latest
    needs: changes
    # Only run if app code changed
    if: needs.changes.outputs.app-code == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'  # Automatic Gradle caching
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
      
      - name: Cache Android build artifacts
        uses: actions/cache@v3
        with:
          path: |
            ~/.android/build-cache
            ${{ github.workspace }}/.gradle
            app/build
          key: ${{ runner.os }}-android-lint-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-android-lint-
            ${{ runner.os }}-android-
      
      - name: Run security-focused lint
        run: |
          ./gradlew lint --stacktrace \
            -Pandroid.lint.checkAllWarnings=true \
            -Pandroid.lint.checkSecurity=true \
            -Pandroid.lint.checkHardcodedValues=true \
            -Pandroid.lint.checkInsecureRandom=true \
            -Pandroid.lint.checkSSLVulnerability=true \
            -Pandroid.lint.checkWeakCryptography=true \
            --no-daemon \
            --parallel
        continue-on-error: true
      
      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-lint-results
          path: app/build/reports/lint-results*.html
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Comment PR with findings
        if: github.event_name == 'pull_request' && always() && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ”’ Security Lint Results\n\nâš ï¸ **Security linting issues detected**\n\nPlease review the lint report in workflow artifacts and fix security issues before merging.\n\n**Common issues:**\n- Hardcoded values (secrets, API keys)\n- Insecure random number generation\n- SSL/TLS vulnerabilities\n- Weak cryptography\n\nðŸ“Š Full lint report available in workflow artifacts.\nðŸ” Review and fix security issues before merging.'
            });
      
      - name: Fail if security issues found
        if: failure()
        run: |
          echo "âŒ Security linting issues detected"
          echo "Please review the lint report and fix security issues."
          exit 1

  # Final status check - aggregates all security checks
  security-status:
    name: Security Status
    runs-on: ubuntu-latest
    needs: [changes, secret-scan, dependency-scan, security-lint]
    if: always()
    
    steps:
      - name: Check security scan results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'skipped' && 'Skipped (no dependency changes)' || needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Lint | ${{ needs.security-lint.result == 'skipped' && 'Skipped (no app code changes)' || needs.security-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          SECRET_SCAN="${{ needs.secret-scan.result }}"
          DEP_SCAN="${{ needs.dependency-scan.result }}"
          LINT="${{ needs.security-lint.result }}"
          
          if [ "$SECRET_SCAN" = "failure" ] || [ "$DEP_SCAN" = "failure" ] || [ "$LINT" = "failure" ]; then
            echo "âŒ Security checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "$SECRET_SCAN" = "success" ] && ([ "$DEP_SCAN" = "success" ] || [ "$DEP_SCAN" = "skipped" ]) && ([ "$LINT" = "success" ] || [ "$LINT" = "skipped" ]); then
            echo "âœ… All security checks passed" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âš ï¸ Some security checks were skipped" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

